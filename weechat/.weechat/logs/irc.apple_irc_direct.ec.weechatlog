2013-04-22 13:14:51	EC	Also, Apple can’t be associated with this issue in any way
2013-04-22 13:14:59	EC	I probably should not have opened the issue
2013-04-22 13:15:17	EC	Even though I did it on my own equipment on my own time
2013-04-22 18:16:08	###	irc: disconnected from server
2013-04-23 11:08:02	greggroth	I'll make sure to not reference anything that could be potentially linked to apple.
2013-04-23 11:08:02	###	EC: No such nick/channel
2013-04-24 14:21:10	EC	What’s your status?
2013-04-24 14:24:44	greggroth	I have a spec that reproduces the empty hash key bug in intersect and a similar spec in your test application.
2013-04-24 14:25:07	greggroth	Using that, I've see where things happen different between the two
2013-04-24 14:25:14	greggroth	but still can't figure out why.
2013-04-24 14:25:59	EC	Meaning why the nested attributes are saved at the root level under an empty key?
2013-04-24 14:26:03	greggroth	I haven't been able to reproduce the empty hash key bug in your test app
2013-04-24 14:26:13	EC	Hmm
2013-04-24 14:26:19	greggroth	that's correct -- but only for intersect
2013-04-24 14:26:26	EC	What’s your Mongo version?
2013-04-24 14:26:46	greggroth	2.4.2
2013-04-24 14:27:11	EC	With the test app, what steps are you taking to reproduce the issue?
2013-04-24 14:27:49	greggroth	    t = Train.create!(cars: [ { seats: [{color: 'red'}, {color: 'blue'}] } ])
2013-04-24 14:27:49	greggroth	    t.update_attributes(cars: [ {seats: [{color: 'yellow'}]} ])
2013-04-24 14:27:49	greggroth	    t.reload
2013-04-24 14:27:53	EC	(Aside: I’ve got Messages set up but only for im.apple.com)
2013-04-24 14:28:25	EC	Are you using the code I attached or have you modified it?
2013-04-24 14:29:11	greggroth	I started with the code you attached and have since modified it to more closely mirror the lesson-step-grid_item-grid_item_content relationship
2013-04-24 14:29:25	EC	Okay cool.
2013-04-24 14:29:31	EC	Send me a copy of your test code?
2013-04-24 14:29:38	greggroth	k 1 sec
2013-04-24 14:29:39	EC	I’ll take a look.
2013-04-24 14:31:27	EC	It’s somewhat amazing what conditions have to be present for the issue to occur.
2013-04-24 14:32:50	EC	I spent about 2 days last week mapping out the full call stack before I understood what was going on.
2013-04-24 14:33:48	greggroth	I just sent it to you.
2013-04-24 14:34:41	greggroth	on intersect, it gets a memoized key for 'steps' that is '' while in the test app it always gets the correct key
2013-04-24 14:34:50	greggroth	hense removing the memoization fixes it
2013-04-24 14:35:15	greggroth	but of corse that could just be a symptom of a larger problem
2013-04-24 14:35:46	EC	Got it.
2013-04-24 14:36:01	EC	Yes that sounds different from the issue I filed but may stem from the same problem.
2013-04-24 14:36:14	EC	Also, what Cucumber feature exhibits the issue?
2013-04-24 14:37:47	greggroth	lessons_management on line 419
2013-04-24 14:38:56	EC	I’m going to grab lunch and come back. Then I’ll dig in and see what I can find.
2013-04-24 14:39:12	EC	Back in 10.
2013-04-24 14:40:07	greggroth	k
2013-04-24 14:52:21	EC	Have you identified any reduced steps to reproduce the issue in Intersect?
2013-04-24 14:52:37	EC	For example, create a step, create a grid item, save.
2013-04-24 15:06:09	greggroth	      lesson = Creator::Lesson.create!
2013-04-24 15:06:09	greggroth	      lesson.update_attributes(new_attributes)
2013-04-24 15:06:09	greggroth	      lesson.reload
2013-04-24 15:06:17	greggroth	that's the test I wrote for intersect
2013-04-24 15:06:32	greggroth	    let(:new_attributes) {
2013-04-24 15:06:32	greggroth	      {
2013-04-24 15:06:32	greggroth	        steps: [
2013-04-24 15:06:32	greggroth	          {
2013-04-24 15:06:32	greggroth	            id: "4b123",
2013-04-24 15:06:32	greggroth	            grid_items: [
2013-04-24 15:06:32	greggroth	              {
2013-04-24 15:06:32	greggroth	                id: "g1",
2013-04-24 15:06:32	greggroth	                style: "text",
2013-04-24 15:06:32	greggroth	                text: "No, there's already a soda like that - Soylen
2013-04-24 15:06:44	greggroth	hmm pasting in irc is not very good.
2013-04-24 15:06:54	EC	lol
2013-04-24 15:07:05	greggroth	it's the same attribtues hash used in lessons_management.feature right before 419
2013-04-24 15:07:09	EC	Got it
2013-04-24 15:07:18	EC	I have a hypothesis but can’t articulate it yet
2013-04-24 15:07:27	greggroth	haha  I know the feeling
2013-04-24 15:11:04	EC	Actually there are a couple possibilities.
2013-04-24 15:12:08	EC	I don’t see any accepts_nested_attributes statements in Lesson or Step so these hypotheses could be affected by that
2013-04-24 15:12:12	EC	But one is…
2013-04-24 15:12:40	EC	During the PUT/update the steps relation is being replaced with a new one.
2013-04-24 15:12:52	EC	So a new Step is being built
2013-04-24 15:13:09	EC	And is not attached to the lesson yet when its GridItem is built 
2013-04-24 15:13:15	greggroth	right
2013-04-24 15:13:24	EC	As a result the GridItem generates the wrong path
2013-04-24 15:13:37	EC	Then the Step is attached to the Lesson
2013-04-24 15:13:41	EC	And the Lesson is saved
2013-04-24 15:13:50	EC	Sending the update with the wrong path for the GridItem
2013-04-24 15:14:04	greggroth	as for `accepts_nested_attributes` -- I don't believe it's necessaru since we're not updating the exisiting steps, but rather overwriting the steps array as a whol
2013-04-24 15:14:05	greggroth	e
2013-04-24 15:14:16	EC	Ahhh
2013-04-24 15:14:29	EC	That seems quite likely, then
2013-04-24 15:16:07	greggroth	another side note -- aparently mongomapper was sloppy with accepts_nested_attributes because Aubrey and Jonathan were saying they've fixed a number of failures by updating the list
2013-04-24 15:16:25	EC	List of?
2013-04-24 15:16:34	EC	attr_accessibles?
2013-04-24 15:17:03	greggroth	oh yeah that one
2013-04-24 15:17:06	greggroth	my bad.
2013-04-24 15:19:30	greggroth	Embedded::Many#position is where I've been looking
2013-04-24 15:20:31	greggroth	but the larger problem is that the relationship is overwritten (as you've pointed out)
2013-04-24 15:21:17	EC	Taking a guess and seeing if I can recreate in the test app
2013-04-24 15:36:42	EC	Oh
2013-04-24 15:37:07	EC	This could also be a result of the nested GoLives
2013-04-24 15:37:46	EC	Break on lib/creator/save_from_api.rb:19 and take a look at the attributes being passed to the mass-assignment call
2013-04-24 15:38:11	EC	I love debugging
2013-04-24 15:43:10	EC	No
2013-04-24 15:43:17	EC	It’s definitely isolated to steps
2013-04-24 15:43:37	EC	I removed all keys except “steps” from attributes before it was passed to update_attributes. Still failed.
2013-04-24 15:44:06	EC	Is it helpful to call out what I’m doing as I go or would you rather just know when I find something?
2013-04-24 15:46:31	EC	Hmm
2013-04-24 15:46:55	EC	If I remove the grid_items attributes from the steps attributes and leave everything else I get past the Mongoid conflicting-mods exception
2013-04-24 15:47:01	EC	So it looks like the issue arises in grid items
2013-04-24 15:47:09	EC	content_attributes is my next suspect
2013-04-24 15:48:55	greggroth	no stream of consiousness is great.  You might hit on something for me.
2013-04-24 15:49:14	greggroth	*hit on something I've checked or might trigger a new idea
2013-04-24 15:49:34	EC	Removing content_attributes had no effect
2013-04-24 16:27:35	EC	Reduced the steps to reproduce to:
2013-04-24 16:27:39	EC	l = Creator::Lesson.create!
2013-04-24 16:27:40	EC	l.update_attributes(steps: [{grid_items: [{}]}])
2013-04-24 16:28:02	EC	Trying another theory in the test app
2013-04-24 16:28:10	EC	*hypothesis
2013-04-24 16:29:07	EC	Nope
2013-04-24 16:29:10	EC	Reduction continues
2013-04-24 16:32:34	EC	Reduced GridItem down to this and the issue persists: https://code.apple.com/gist/d68c31c7add98362ed13
2013-04-24 16:40:40	greggroth	I had the same finding when I tried that last week
2013-04-24 16:40:51	greggroth	Do you see the bug happening in the test app still?
2013-04-24 16:40:57	EC	Not yet
2013-04-24 16:41:03	EC	Reduced Step down
2013-04-24 16:41:04	EC	https://code.apple.com/gist/d68c31c7add98362ed13
2013-04-24 16:41:13	EC	(Also, Gist is F’d up)
2013-04-24 16:41:34	EC	If you comment out the attr_accessible in the Step the issue goes away *and* the grid item is saved
2013-04-24 16:41:39	EC	Restore it and the issue occurs
2013-04-24 16:42:14	EC	Attempting reproduction in test app
2013-04-24 16:43:48	EC	Whoa
2013-04-24 16:43:55	EC	Something weird happened in the test app now
2013-04-24 16:44:05	EC	Now it’s just saving the Train itself
2013-04-24 16:46:58	greggroth	I was just talking with Aubrey and he said that the cucumber failures are down to the ones related to this bug.  He's going to try the monkey patch with the entire test suite and see how that goes.
2013-04-24 16:47:08	EC	k
2013-04-24 16:52:32	EC	This is taking a different path than the issue I filed
2013-04-24 16:53:00	EC	It’s recognizing “cars” as a relation and sending through #pending_relations instead of #pending_nested
2013-04-24 17:24:05	EC	Got it
2013-04-24 17:24:17	EC	It is the same issue
2013-04-24 17:24:31	EC	Packaging up test app so you can confirm reproduction
2013-04-24 17:28:48	EC	Emailed to you
2013-04-24 17:29:51	EC	Now I’m going to step through it in Intersect
2013-04-24 17:33:55	EC	Good to know that #capacity= is unnecessary
2013-04-24 17:34:08	EC	Can reduce the test case attached to that issue a bit
2013-04-24 18:45:35	###	irc: disconnected from server
2013-04-26 09:20:08	###	irc: disconnected from server
2013-04-26 17:01:08	###	irc: disconnected from server
